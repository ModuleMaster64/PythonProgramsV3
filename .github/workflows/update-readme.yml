name: ğŸ§  Update README Stats

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/50 * * * *'  # Runs every 50 minutes!

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Count Python files and lines
      run: |
        PY_FILES=$(find . -name "*.py" | wc -l)
        TOTAL_LINES=$(find . -name "*.py" -exec cat {} + | wc -l)
        echo "PY_FILES=$PY_FILES" >> $GITHUB_ENV
        echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_ENV

    - name: Get commit counts by author
      run: |
        echo "TOP_AUTHORS=$(git shortlog -sn | head -n 5 | awk '{print \"ğŸ‘¤ \"$2 \" \"$1}' | paste -sd '\\n')" >> $GITHUB_ENV

    - name: Update README.md
      run: |
        STATS="ğŸ“„ Total lines of code: $TOTAL_LINES\nğŸ Number of Python files: $PY_FILES\n\nğŸ”¢ Top contributors:\n$TOP_AUTHORS"
        DATE="ğŸ•’ Last updated: $(date -u +"%Y-%m-%d %H:%M UTC")"

        sed -i "/<!-- STATS:START -->/,/<!-- STATS:END -->/c\\<!-- STATS:START -->\n$STATS\n<!-- STATS:END -->" README.md
        sed -i "/<!-- UPDATED:START -->/,/<!-- UPDATED:END -->/c\\<!-- UPDATED:START -->\n$DATE\n<!-- UPDATED:END -->" README.md

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add README.md
        git commit --allow-empty -m "ğŸ§  Update README stats"
        git push
