name: üß† Update README Stats

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/50 * * * *'  # Runs every 50 minutes!

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Count Python files and lines
      run: |
        PY_FILES=$(find . -name "*.py" | wc -l)
        TOTAL_LINES=$(find . -name "*.py" -exec cat {} + | wc -l)
        echo "PY_FILES=$PY_FILES" >> $GITHUB_ENV
        echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_ENV

    - name: Get commit counts by author
      run: |
        git shortlog -sn | head -n 5 | awk '{print "üë§ " $2 " " $1}' > authors.txt

    - name: Update README.md
      run: |
        STATS="üìÑ Total lines of code: $TOTAL_LINES\nüêç Number of Python files: $PY_FILES\n\nüî¢ Top contributors:"
        DATE="üïí Last updated: $(date -u +"%Y-%m-%d %H:%M UTC")"

        {
          echo "<!-- STATS:START -->"
          echo -e "$STATS"
          cat authors.txt
          echo "<!-- STATS:END -->"
        } > stats_block.txt

        {
          echo "<!-- UPDATED:START -->"
          echo "$DATE"
          echo "<!-- UPDATED:END -->"
        } > updated_block.txt

        awk '
          BEGIN { stats=0; updated=0 }
          /<!-- STATS:START -->/ { print; stats=1; next }
          /<!-- STATS:END -->/ {
            while ((getline line < "stats_block.txt") > 0) print line
            stats=0
            next
          }
          /<!-- UPDATED:START -->/ { print; updated=1; next }
          /<!-- UPDATED:END -->/ {
            while ((getline line < "updated_block.txt") > 0) print line
            updated=0
            next
          }
          stats || updated { next }
          { print }
        ' README.md > README.tmp && mv README.tmp README.md

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add README.md
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
        git commit --allow-empty -m "üß† Update README stats [$TIMESTAMP]"
        git push
